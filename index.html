<script>
    let gameScores = JSON.parse(localStorage.getItem('gameScores')) || {
        'ff': 0,
        'pubg': 0,
        'pubg2': 0,
        'cod': 0,
        'ff2': 0,
        'cod2': 0
    };

    let battleStats = JSON.parse(localStorage.getItem('battleStats')) || {
        'ff-pubg': 0,
        'pubg-cod': 0,
        'ff-cod': 0
    };

    let userVotes = JSON.parse(localStorage.getItem('userVotes')) || {}; // { "ff-pubg": "ff" }

    function vote(battle, game, type) {
        // Vérifie si l'utilisateur a déjà voté pour cette battle
        const previousVote = userVotes[battle];

        // Annule l'ancien vote si l'utilisateur change d'avis
        if (previousVote && previousVote !== game) {
            gameScores[previousVote] -= 1;
            battleStats[battle] -= 1;
        }

        // Si c’est un nouveau vote ou un changement
        userVotes[battle] = game;

        // Applique le nouveau vote
        if (type === 'up') {
            gameScores[game] += 1;
        } else {
            gameScores[game] -= 1;
        }

        battleStats[battle] += 1;

        // Enregistre dans localStorage
        localStorage.setItem('gameScores', JSON.stringify(gameScores));
        localStorage.setItem('battleStats', JSON.stringify(battleStats));
        localStorage.setItem('userVotes', JSON.stringify(userVotes));

        updateScores();
        updateStats();
        animateVote(game, type);
    }

    function updateScores() {
        Object.keys(gameScores).forEach(game => {
            const element = document.getElementById(game + '-score');
            if (element) {
                element.textContent = gameScores[game];
                element.style.color =
                    gameScores[game] > 0 ? '#4CAF50' :
                    gameScores[game] < 0 ? '#f44336' :
                    '#FFD700';
            }
        });
    }

    function updateStats() {
        const totalVotes = Object.values(battleStats).reduce((a, b) => a + b, 0);
        document.getElementById('total-votes').textContent = totalVotes;

        const topGame = Object.keys(gameScores).reduce((a, b) => gameScores[a] > gameScores[b] ? a : b);
        const gameNames = {
            'ff': 'Free Fire', 'ff2': 'Free Fire',
            'pubg': 'PUBG', 'pubg2': 'PUBG',
            'cod': 'Call of Duty', 'cod2': 'Call of Duty'
        };
        document.getElementById('top-game').textContent = totalVotes > 0 ? gameNames[topGame] : 'Aucun vote encore';

        const activeBattle = Object.keys(battleStats).reduce((a, b) => battleStats[a] > battleStats[b] ? a : b);
        const battleNames = {
            'ff-pubg': 'Free Fire vs PUBG',
            'pubg-cod': 'PUBG vs Call of Duty',
            'ff-cod': 'Free Fire vs Call of Duty'
        };
        document.getElementById('active-battle').textContent = totalVotes > 0 ? battleNames[activeBattle] : 'En attente...';
    }

    function animateVote(game, type) {
        const scoreElement = document.getElementById(game + '-score');
        scoreElement.style.transform = 'scale(1.3)';
        scoreElement.style.transition = 'transform 0.3s ease';
        setTimeout(() => {
            scoreElement.style.transform = 'scale(1)';
        }, 300);
    }

    // Au chargement
    updateScores();
    updateStats();
</script>
